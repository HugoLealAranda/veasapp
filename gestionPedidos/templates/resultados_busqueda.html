{% extends "base.html" %}

{% block content %}
<!-- Barra superior con "Estás buscando", gráfico pequeño y botón -->
<div class="container mt-4 mb-4">
    <div class="row align-items-center">
        <!-- Texto: Estás buscando -->
        <div class="col-md-4">
            <h2 class="mb-3">
                Estás buscando: <strong>{{ query }}</strong>
            </h2>
        </div>

        <!-- Pequeño gráfico tipo barra horizontal -->
        <div class="col-md-4 d-flex justify-content-center">
            <div class="small-chart-container">
                <canvas id="mySmallChart"></canvas>
            </div>
        </div>

        <!-- Botón de Descargar PDF -->
        <div class="col-md-4 text-right">
            <button class="btn btn-primary" onclick="printPage()">Descargar PDF o Imprimir</button>
        </div>
    </div>
</div>

{% if metricas1 %}
<div class="container">
    <!-- Fila de métricas -->
    <div class="row metrica1-container">
        <div class="col-sm-6 col-md-4 col-lg-3">
            <div class="card shadow mb-4 metrica1-card">
                <div class="card-body">
                    <div class="metrica-titulo">Último valor de Venta por Rental Veas</div>
                    {% if metricas1.valor_unitario_venta_rental_veas != 'No disponible' %}
                        {% if metricas1.valor_unitario_venta_rental_veas %}
                            <div class="metrica-valor">${{ metricas1.valor_unitario_venta_rental_veas }}</div>
                        {% else %}
                            <div class="metrica-valor">No disponible</div>
                        {% endif %}
                    {% else %}
                        <div class="metrica-valor">No disponible</div>
                    {% endif %}
                </div>
            </div>
        </div>
        
        <div class="col-sm-6 col-md-4 col-lg-3">
            <div class="card shadow mb-4 metrica1-card">
                <div class="card-body">
                    <div class="metrica-titulo">Último valor de Compra por Rental Veas</div>
                    {% if metricas1.valor_unitario_compra_rental_veas != 'No disponible' %}
                        {% if metricas1.valor_unitario_compra_rental_veas %}
                            <div class="metrica-valor">${{ metricas1.valor_unitario_compra_rental_veas }}</div>
                        {% else %}
                            <div class="metrica-valor">No disponible</div>
                        {% endif %}
                    {% else %}
                        <div class="metrica-valor">No disponible</div>
                    {% endif %}
                </div>
            </div>
        </div>
        
        <div class="col-sm-6 col-md-4 col-lg-3">
            <div class="card shadow mb-4 metrica1-card">
                <div class="card-body">
                    <div class="metrica-titulo">Último valor Cotizado desde Rental Veas a clientes</div>
                    {% if metricas1.valor_unitario_cotizado_rental_veas != 'No disponible' %}
                        {% if metricas1.valor_unitario_cotizado_rental_veas %}
                            <div class="metrica-valor">${{ metricas1.valor_unitario_cotizado_rental_veas }}</div>
                        {% else %}
                            <div class="metrica-valor">No disponible</div>
                        {% endif %}
                    {% else %}
                        <div class="metrica-valor">No disponible</div>
                    {% endif %}
                </div>
            </div>
        </div>
        
        <div class="col-sm-6 col-md-4 col-lg-3">
            <div class="card shadow mb-4 metrica1-card">
                <div class="card-body">
                    <div class="metrica-titulo">Último valor Cotizado desde Proveedores a Rental Veas</div>
                    {% if metricas1.valor_unitario_cotizado_proveedores != 'No disponible' %}
                        {% if metricas1.valor_unitario_cotizado_proveedores %}
                            <div class="metrica-valor">${{ metricas1.valor_unitario_cotizado_proveedores }}</div>
                        {% else %}
                            <div class="metrica-valor">No disponible</div>
                        {% endif %}
                    {% else %}
                        <div class="metrica-valor">No disponible</div>
                    {% endif %}
                </div>
            </div>
        </div>
        
        <!-- Precio Promedio Venta -->
        <div class="col-sm-6 col-md-4 col-lg-3">
            <div class="card shadow mb-4 metrica1-card">
                <div class="card-body">
                    <div class="metrica-titulo">Precio Promedio de Ventas de Rental Veas</div>
                    {% if metricas1.promedio_venta_valor_unitario != 'No disponible' %}
                        {% if metricas1.promedio_venta_valor_unitario %}
                            <div class="metrica-valor">${{ metricas1.promedio_venta_valor_unitario }}</div>
                        {% else %}
                            <div class="metrica-valor">No disponible</div>
                        {% endif %}
                    {% else %}
                        <div class="metrica-valor">No disponible</div>
                    {% endif %}
                </div>
            </div>
        </div>
        
        <!-- Precio Promedio Compra -->
        <div class="col-sm-6 col-md-4 col-lg-3">
            <div class="card shadow mb-4 metrica1-card">
                <div class="card-body">
                    <div class="metrica-titulo">Precio Promedio de Compra de Rental Veas</div>
                    {% if metricas1.promedio_compra_valor_unitario != 'No disponible' %}
                        {% if metricas1.promedio_compra_valor_unitario %}
                            <div class="metrica-valor">${{ metricas1.promedio_compra_valor_unitario }}</div>
                        {% else %}
                            <div class="metrica-valor">No disponible</div>
                        {% endif %}
                    {% else %}
                        <div class="metrica-valor">No disponible</div>
                    {% endif %}
                </div>
            </div>
        </div>
        
        <!-- Utilidades -->
        <div class="col-sm-6 col-md-4 col-lg-3">
            <div class="card shadow mb-4 metrica1-card">
                <div class="card-body">
                    <div class="metrica-titulo">Utilidad del producto en la Última Compraventa</div>
                    {% if metricas1.utilidad_ultima_compraventa != 'No disponible' %}
                        {% if metricas1.utilidad_ultima_compraventa %}
                            <div class="metrica-valor">
                                ${{ metricas1.utilidad_ultima_compraventa|floatformat:2 }}
                            </div>
                        {% else %}
                            <div class="metrica-valor">No disponible</div>
                        {% endif %}
                    {% else %}
                        <div class="metrica-valor">No disponible</div>
                    {% endif %}
                </div>
            </div>
        </div>
        
        <div class="col-sm-6 col-md-4 col-lg-3">
            <div class="card shadow mb-4 metrica1-card">
                <div class="card-body">
                    <div class="metrica-titulo">Utilidad promedio del producto</div>
                    {% if metricas1.utilidad_promedio_historica != 'No disponible' %}
                        {% if metricas1.utilidad_promedio_historica %}
                            <div class="metrica-valor">
                                ${{ metricas1.utilidad_promedio_historica|floatformat:2 }}
                            </div>
                        {% else %}
                            <div class="metrica-valor">No disponible</div>
                        {% endif %}
                    {% else %}
                        <div class="metrica-valor">No disponible</div>
                    {% endif %}
                </div>
            </div>
        </div>
    </div>
</div>
{% endif %}

<!-- Gráfico de Barras 1 -->
<div class="container">
    <div class="row">
        <div class="col-12">
            <div class="card chart-card shadow mb-4" id="bar-chart-card">
                <div class="card-body">
                    <canvas id="graficoBarras"></canvas>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Gráfico de Líneas -->
<div class="container">
    <div class="row">
        <div class="col-12">
            <div class="card chart-card shadow mb-4" id="line-chart-card">
                <div class="card-body">
                    <canvas id="myChart"></canvas>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Gráfico de Barras 2 -->
<div class="container">
    <div class="row">
        <div class="col-12">
            <div class="card chart-card shadow mb-4" id="line-chart-card2">
                <div class="card-body">
                    <canvas id="graficodebarras2"></canvas>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Scripts, Bootstrap y estilos -->
<style>
/* Aplica margen superior a las tarjetas, excepto para la primera */
.metrica1-container .metrica1-card:not(:first-child) {
    margin-top: 30px; /* Ajusta el valor del margen superior según sea necesario */
    margin-bottom: 30px;
}
.metrica1-container .metrica1-card .metrica-titulo {
    font-weight: bold;
}
/* Aplica margen superior al contenedor de métricas */
.metrica1-container {
    margin-top: 20px; /* Ajusta el valor del margen superior según sea necesario */
    display: flex;
    justify-content: space-around;
    flex-wrap: wrap;
    gap: 10px; /* Espacio entre tarjetas */
    margin-bottom: 30px;

}
.container8 {
        font-family: Arial, sans-serif;
        border: 1px solid #ccc;
        padding: 20px;
        border-radius: 5px;
        background-color: #f9f9f9;
        max-width: 600px;
        margin: 0 auto;
    }

    .tiempos-espera-titulo {
        font-size: 20px;
        font-weight: bold;
        color: #333;
    }

    .stock-value-container {
        margin-top: 10px;
    }

    .tiempos-espera-container {
        padding-left: 20px;
    }

    .tiempos-espera {
        list-style-type: none;
        padding: 0;
    }

    .tiempos-espera li {
        margin-bottom: 5px;
    }

    .nombre-empresa {
        font-weight: bold;
        color: #007bff;
    }

    .resultado {
        color: #555;
    }
.button {
      background-color: #007bffb4;
      border: none;
      color: white;
      padding: 15px 32px;
      text-align: center;
      text-decoration: none;
      display: inline-block;
      font-size: 16px;
      margin: 4px 2px;
      transition-duration: 0.4s;
      cursor: pointer;
      border-radius: 8px;
      box-shadow: 0px 8px 15px rgba(0, 0, 0, 0.1);
      position: absolute;
    right: 0;
    margin-top: 1em;
    }

    .button:hover {
      background-color: #0057b3c6;
    }
.metrica1-card {
    background: #fff;
    border-left: 4px solid #440af1; /* Cambia el color según la categoría de la métrica */
    margin: 30px; /* Añade margen entre las tarjetas */
    background: #fff;
    border-radius: 30px;
    box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
    padding: 20px; /* Puedes ajustar el padding para ahorrar espacio */
    min-height: 120px; /* Ajusta la altura mínima según sea necesario */
    min-width: 150px
    
}

.tiempos-espera-container {
    max-height: 200px; /* Altura máxima de la lista */
    overflow-y: auto; /* Agrega desplazamiento vertical cuando sea necesario */
}

.tiempos-espera-titulo {
    font-size: 24px; /* Tamaño del título */
}

.nombre-empresa {
    font-size: 14px; /* Tamaño del nombre de la empresa */
}

.resultado {
    font-size: 12px; /* Tamaño del resultado */
}


.container {
  display: flex;
  flex-wrap: wrap;
  position: relative;
  margin-bottom: 30px;

}

.container > * {
  margin-bottom: 20px; /* Ajusta el valor del margen según sea necesario */
  margin-top: 20px;
}

.container2 {
  display: flex;
  flex-direction: column;
  flex-wrap: wrap;
  position: relative;
  width: 300px;
  height: 300px;
  margin: auto; /* Centra horizontalmente */
  margin-top: 20px; /* Ajusta el margen superior según sea necesario */
  margin-bottom: 20px; /* Ajusta el margen inferior según sea necesario */
}





.chart-card {
  flex: 1 1 100%; /* Cada tarjeta ocupa todo el ancho de su contenedor */
  margin-bottom: 10px; /* Añade un margen inferior entre las tarjetas */
  margin-top: 30px;
}

/* Media query para ajustar el diseño cuando la pantalla sea más pequeña */
@media (max-width: 768px) {
  .chart-card {
    flex-basis: 100%; /* Cuando la pantalla sea más pequeña, cada tarjeta ocupará el 100% del ancho */
  }
  .button {
        position: static;
        margin-top: 1em; /* Ajusta este valor según sea necesario */
    }
}

.search-container {
        top: 0;
        left: 0;
        z-index: 1; /* Asegura que el contenedor de búsqueda esté sobre los contenedores de métricas */
        width: 100%; /* Ajusta el ancho del contenedor de búsqueda para que ocupe toda la anchura del contenedor principal */
        padding: 10px; /* Ajusta el relleno según sea necesario */
        box-shadow: 0 4px 8px rgba(0, 0, 0, 0.1); /* Añade sombra si lo deseas */
        margin-top: 10px;
        margin-bottom: 10px;
        background: #fff;
    border-radius: 30px;
    box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);

    }

    .search-container h2 {
        margin: 0;
        font-size: 1.5em;
        color: #333;
        margin-bottom: 20px;
        margin-top: 10px

    }

    .metrica-container {
        display: flex;
        flex-wrap: wrap;
        gap: 20px;
        margin-bottom: 20px;
    }

    .metrica-card {
        background: #fff;
        border-radius: 10px;
        box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
        padding: 15px;
        flex: 1 1 calc(20% - 20px);
        text-align: center;

    }
    .reactive-element {
        background-color: #fff;
        padding: 20px;
        border-radius: 10px;
        text-align: center;
        margin-top: 20px;
        margin-bottom: 20px;

    }

    .stock-label {
        font-size: 24px; /* Ajusta el tamaño del título según sea necesario */
        font-weight: bold;
        color: #333;
        display: block;
        margin-bottom: 20px;
    }

    .stock-value-container {
        font-size: 36px; /* Ajusta el tamaño del número según sea necesario */
        color: #007bff;
        line-height: 1;
    }

    .metrica-titulo {
        font-size: 1.2em;
        color: #333;
        margin-bottom: 10px;
    }

    .tiempos-espera-titulo {
    font-size: 24px; /* Tamaño del título */
    color: black; /* Color del texto */
}


.nombre-empresa {
    font-size: 22px; /* Tamaño del nombre de la empresa */
    color: black; /* Color del texto */
}

.resultado {
    font-size: 18px; /* Tamaño del resultado */
    text-decoration: underline red; /* Subrayado con color rojo */
}



    .metrica-valor {
        font-size: 1.5em;
        font-weight: bold;
        color: #4e73df;
        margin-top: 10px;
        margin-bottom: 30px;

    }
    .cuadro-stock {
                width: 200px;
                height: 200px;
                background-color: #4e73df;
                border: 5px solid #fff;
                border-radius: 10px;
                display: flex;
                flex-direction: column;
                justify-content: center;
                align-items: center;
                font-size: 24px;
                color: #fff;
                text-align: center;
            }

    .numero-stock {
                margin-top: 10px; 
            }


    .charts-row {
        display: flex;
        flex-wrap: wrap;
        gap: 20px;
    }


.card {
    flex: 1 1 300px; /* O cualquier otro valor adecuado */
    max-width: 100%;
    padding: 20px;
    background-color: #f0f0f0;
    border: 1px solid #ccc;
    border-radius: 10px;
    box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
    margin-bottom: 30px;

}

.card .numero-stock {
    font-size: 24px;
}

.numero-stock {
    font-size: 24px;
}
    canvas {
        width: 100%;
        height: auto;
    }


</style>

<!-- Bootstrap CSS desde CDN -->
<link rel="stylesheet" href="https://stackpath.bootstrapcdn.com/bootstrap/4.5.2/css/bootstrap.min.css">

<!-- Bootstrap Bundle JS desde CDN (incluye Popper) -->
<script src="https://stackpath.bootstrapcdn.com/bootstrap/4.5.2/js/bootstrap.bundle.min.js"></script>
<!-- Chart.js -->
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<script src="https://cdn.jsdelivr.net/npm/chartjs-adapter-date-fns"></script>
<script src="https://cdn.jsdelivr.net/npm/chartjs-plugin-annotation@1.0.2"></script>

<!-- Scripts de funcionalidad (mostrar/ocultar, imprimir) -->
<script>
    function showMore() {
        var remainingCards = document.getElementById('remaining');
        if (remainingCards) {
            remainingCards.style.display = 'flex';
        }
        document.getElementById('showMoreBtn').style.display = 'none';
        document.getElementById('showLessBtn').style.display = 'block';
    }

    function showLess() {
        var remainingCards = document.getElementById('remaining');
        if (remainingCards) {
            remainingCards.style.display = 'none';
        }
        document.getElementById('showMoreBtn').style.display = 'block';
        document.getElementById('showLessBtn').style.display = 'none';
    }

    function printPage() {
        window.print();
    }
</script>

<!-- Script para la pequeña gráfica de barra horizontal (ubicada arriba) -->
<script>
    document.addEventListener('DOMContentLoaded', function() {
        // Supongamos que reutilizas la data de etiquetas_pie y valores_pie_chart
        const etiquetas = JSON.parse('{{ etiquetas_pie|safe }}');
        const valores = JSON.parse('{{ valores_pie_chart|safe }}');

        // Configuramos un gráfico de barras horizontal
        const configSmallChart = {
            type: 'bar',
            data: {
                labels: etiquetas,
                datasets: [{
                    label: 'Veces comprado',
                    data: valores,
                    backgroundColor: 'rgba(54, 162, 235, 0.7)',
                    borderColor: 'rgba(54, 162, 235, 1)',
                    borderWidth: 1
                }]
            },
            options: {
                indexAxis: 'y',       // Barras horizontales
                maintainAspectRatio: false,
                animation: {
                    duration: 1500
                },
                plugins: {
                    title: {
                        display: false
                    },
                    legend: {
                        display: false
                    },
                    tooltip: {
                        enabled: true
                    }
                },
                scales: {
                    x: {
                        display: false, // oculta escala para hacerlo más simple
                        beginAtZero: true
                    },
                    y: {
                        display: false  // oculta etiquetas del eje Y
                    }
                }
            }
        };

        var ctxSmall = document.getElementById('mySmallChart').getContext('2d');
        var mySmallChart = new Chart(ctxSmall, configSmallChart);
    });
</script>

<!-- Script para el primer gráfico de barras (Ranking Últimos Precios) -->
<script>
document.addEventListener('DOMContentLoaded', function() {
    var empresas = JSON.parse('{{ empresas|safe }}');
    var valores = JSON.parse('{{ valores|safe }}');

    const backgroundColors = [
        'rgb(255, 99, 132)',
        'rgb(255, 159, 64)',
        'rgb(255, 205, 86)',
        'rgb(75, 192, 192)',
        'rgb(54, 162, 235)',
        'rgb(153, 102, 255)',
        'rgb(201, 203, 207)'
    ];

    const minValueIndex = valores.indexOf(Math.min(...valores));
    let customBackgroundColors = [...backgroundColors].slice(0, empresas.length);
    let customBorderColors = [...backgroundColors].slice(0, empresas.length);
    
    customBackgroundColors[minValueIndex] = 'rgb(102, 187, 106)'; 
    customBorderColors[minValueIndex] = 'rgb(102, 187, 106)';

    var ctx = document.getElementById('graficoBarras').getContext('2d');
    var graficoBarras = new Chart(ctx, {
        type: 'bar',
        data: {
            labels: empresas,
            datasets: [{
                label: 'Ranking Últimos Precios por Proveedor',
                data: valores,
                backgroundColor: customBackgroundColors,
                borderColor: customBorderColors,
                borderWidth: 2
            }]
        },
        options: {
            maintainAspectRatio: false,
            scales: {
                x: { gridLines: { display: false } },
                y: { beginAtZero: true, gridLines: { display: true } }
            },
            legend: { display: false },
            tooltips: { mode: 'index', intersect: false },
            animation: { duration: 2000 },
            plugins: {
                annotation: {
                    annotations: [{
                        type: 'line',
                        mode: 'vertical',
                        scaleID: 'x',
                        value: empresas[minValueIndex],
                        borderColor: 'red',
                        borderWidth: 3,
                        label: {
                            enabled: true,
                            content: 'Mejor precio',
                            position: 'top',
                            backgroundColor: 'rgba(255, 99, 132, 0.8)',
                            yAdjust: -6,
                        }
                    }]
                }
            }
        }
    });
});
</script>

<!-- Script para el gráfico de líneas -->
<script>
    document.addEventListener('DOMContentLoaded', function() {
        const fechasCompraRentalVeas = JSON.parse('{{ fechas_compra_rental_veas|safe }}');
        const valoresUnitariosCompraRentalVeas = JSON.parse('{{ valores_unitarios_compra_rental_veas|safe }}');
        const fechasVentaRentalVeas = JSON.parse('{{ fechas_venta_rental_veas|safe }}');
        const valoresUnitariosVentaRentalVeas = JSON.parse('{{ valores_unitarios_venta_rental_veas|safe }}');
        const fechasCotizacionRentalVeas = JSON.parse('{{ fechas_cotizacion_rental_veas|safe }}');
        const valoresUnitariosCotizacionRentalVeas = JSON.parse('{{ valores_unitarios_cotizacion_rental_veas|safe }}');
        const fechasCotizacionProveedores = JSON.parse('{{ fechas_cotizacion_proveedores|safe }}');
        const valoresUnitariosCotizacionProveedores = JSON.parse('{{ valores_unitarios_cotizacion_proveedores|safe }}');
        const numerosDocumentosCompraRentalVeas = JSON.parse('{{ numeros_documentos_compra_rental_veas|safe }}');
        const numerosDocumentosVentaRentalVeas = JSON.parse('{{ numeros_documentos_venta_rental_veas|safe }}');
        const numerosDocumentosCotizacionRentalVeas = JSON.parse('{{ numeros_documentos_cotizacion_rental_veas|safe }}');
        const numerosDocumentosCotizacionProveedores = JSON.parse('{{ numeros_documentos_cotizacion_proveedores|safe }}');
        
        const datosCompraRentalVeas = fechasCompraRentalVeas.map((fecha, index) => ({
            x: fecha,
            y: valoresUnitariosCompraRentalVeas[index],
            label: numerosDocumentosCompraRentalVeas[index]
        }));

        const datosVentaRentalVeas = fechasVentaRentalVeas.map((fecha, index) => ({
            x: fecha,
            y: valoresUnitariosVentaRentalVeas[index],
            label: numerosDocumentosVentaRentalVeas[index]
        }));

        const datosCotizacionRentalVeas = fechasCotizacionRentalVeas.map((fecha, index) => ({
            x: fecha,
            y: valoresUnitariosCotizacionRentalVeas[index],
            label: numerosDocumentosCotizacionRentalVeas[index]
        }));

        const datosCotizacionProveedores = fechasCotizacionProveedores.map((fecha, index) => ({
            x: fecha,
            y: valoresUnitariosCotizacionProveedores[index],
            label: numerosDocumentosCotizacionProveedores[index]
        }));

        const config = {
            type: 'line',
            data: {
                datasets: [
                    {
                        label: 'Compras de Rental Veas',
                        data: datosCompraRentalVeas,
                        fill: false,
                        borderColor: 'rgb(255, 99, 132)',
                        tension: 0.05,
                        pointRadius: 6
                    },
                    {
                        label: 'Ventas de Rental Veas',
                        data: datosVentaRentalVeas,
                        fill: false,
                        borderColor: 'rgb(54, 162, 235)',
                        tension: 0.05,
                        pointRadius: 6
                    },
                    {
                        label: 'Cotizaciones a Clientes',
                        data: datosCotizacionRentalVeas,
                        fill: false,
                        borderColor: 'rgb(140, 230, 20)',
                        tension: 0.05,
                        pointRadius: 6
                    },
                    {
                        label: 'Cotizaciones de Proveedores',
                        data: datosCotizacionProveedores,
                        fill: false,
                        borderColor: 'rgb(153, 102, 255)',
                        tension: 0.05,
                        pointRadius: 6
                    }
                ]
            },
            options: {
                maintainAspectRatio: false,
                scales: {
                    x: {
                        type: 'time',
                        time: {
                            unit: 'month',
                            tooltipFormat: 'yyyy-MM-dd'
                        },
                        distribution: 'linear'
                    }
                },
                plugins: {
                    tooltip: {
                        mode: 'index',
                        intersect: false,
                        callbacks: {
                            label: function(context) {
                                let label = context.dataset.label || '';
                                if (label) {
                                    label += ': ';
                                }
                                label += context.parsed.y;
                                return label;
                            }
                        }
                    },
                    title: {
                        display: true,
                        text: 'Evolución de Precios',
                        font: {
                            size: 20
                        }
                    }
                },
                hover: {
                    mode: 'nearest',
                    intersect: true
                },
                onClick: function(event, elements) {
                    if (elements.length > 0) {
                        const datasetIndex = elements[0].datasetIndex;
                        const index = elements[0].index;
                        const datasetLabel = config.data.datasets[datasetIndex].label;
                        const label = config.data.datasets[datasetIndex].data[index].label;
                        alert(`${datasetLabel}: ${label}`);
                    }
                }
            }
        };

        var myChart = new Chart(
            document.getElementById('myChart'),
            config
        );
    });
</script>

<!-- Script para el segundo gráfico de barras (Evolución de Precios en Barras) -->
<script>
document.addEventListener('DOMContentLoaded', function() {
    const fechasCompraRentalVeas = JSON.parse('{{ fechas_compra_rental_veas|safe }}');
    const valoresUnitariosCompraRentalVeas = JSON.parse('{{ valores_unitarios_compra_rental_veas|safe }}');
    const fechasVentaRentalVeas = JSON.parse('{{ fechas_venta_rental_veas|safe }}');
    const valoresUnitariosVentaRentalVeas = JSON.parse('{{ valores_unitarios_venta_rental_veas|safe }}');
    const fechasCotizacionRentalVeas = JSON.parse('{{ fechas_cotizacion_rental_veas|safe }}');
    const valoresUnitariosCotizacionRentalVeas = JSON.parse('{{ valores_unitarios_cotizacion_rental_veas|safe }}');
    const fechasCotizacionProveedores = JSON.parse('{{ fechas_cotizacion_proveedores|safe }}');
    const valoresUnitariosCotizacionProveedores = JSON.parse('{{ valores_unitarios_cotizacion_proveedores|safe }}');
    const numerosDocumentosCompraRentalVeas = JSON.parse('{{ numeros_documentos_compra_rental_veas|safe }}');
    const numerosDocumentosVentaRentalVeas = JSON.parse('{{ numeros_documentos_venta_rental_veas|safe }}');
    const numerosDocumentosCotizacionRentalVeas = JSON.parse('{{ numeros_documentos_cotizacion_rental_veas|safe }}');
    const numerosDocumentosCotizacionProveedores = JSON.parse('{{ numeros_documentos_cotizacion_proveedores|safe }}');

    const datosCompraRentalVeas = fechasCompraRentalVeas.map((fecha, index) => ({
        x: fecha,
        y: valoresUnitariosCompraRentalVeas[index],
        label: numerosDocumentosCompraRentalVeas[index]
    }));

    const datosVentaRentalVeas = fechasVentaRentalVeas.map((fecha, index) => ({
        x: fecha,
        y: valoresUnitariosVentaRentalVeas[index],
        label: numerosDocumentosVentaRentalVeas[index]
    }));

    const datosCotizacionRentalVeas = fechasCotizacionRentalVeas.map((fecha, index) => ({
        x: fecha,
        y: valoresUnitariosCotizacionRentalVeas[index],
        label: numerosDocumentosCotizacionRentalVeas[index]
    }));

    const datosCotizacionProveedores = fechasCotizacionProveedores.map((fecha, index) => ({
        x: fecha,
        y: valoresUnitariosCotizacionProveedores[index],
        label: numerosDocumentosCotizacionProveedores[index]
    }));

    const config = {
        type: 'bar',
        data: {
            labels: fechasCompraRentalVeas,
            datasets: [
                {
                    label: 'Compras de Rental Veas',
                    data: datosCompraRentalVeas,
                    backgroundColor: 'rgb(255, 99, 132)',
                    barThickness: 20,
                    borderWidth: 1,
                },
                {
                    label: 'Ventas de Rental Veas',
                    data: datosVentaRentalVeas,
                    backgroundColor: 'rgb(54, 162, 235)',
                    barThickness: 10,
                    borderWidth: 1,
                },
                {
                    label: 'Cotizaciones a Clientes',
                    data: datosCotizacionRentalVeas,
                    backgroundColor: 'rgb(140, 230, 20)',
                    barThickness: 20,
                    borderWidth: 1,
                },
                {
                    label: 'Cotizaciones de Proveedores',
                    data: datosCotizacionProveedores,
                    backgroundColor: 'rgb(153, 102, 255)',
                    barThickness: 20,
                    borderWidth: 1,
                }
            ]
        },
        options: {
            maintainAspectRatio: false,
            scales: {
                x: {
                    type: 'time',
                    time: {
                        unit: 'month',
                        tooltipFormat: 'yyyy-MM-dd'
                    },
                    distribution: 'linear'
                },
                y: {
                    beginAtZero: true
                }
            },
            plugins: {
                tooltip: {
                    mode: 'index',
                    intersect: false,
                    callbacks: {
                        label: function(context) {
                            let label = context.dataset.label || '';
                            if (label) {
                                label += ': ';
                            }
                            label += context.parsed.y;
                            return label;
                        }
                    }
                },
                title: {
                    display: true,
                    text: 'Evolución de Precios',
                    font: {
                        size: 20
                    }
                }
            },
            onClick: function(event, elements) {
                if (elements.length > 0) {
                    const datasetIndex = elements[0].datasetIndex;
                    const index = elements[0].index;
                    const datasetLabel = config.data.datasets[datasetIndex].label;
                    const label = config.data.datasets[datasetIndex].data[index].label;
                    alert(`${datasetLabel}: ${label}`);
                }
            }
        }
    };

    var myChart = new Chart(
        document.getElementById('graficodebarras2'),
        config
    );
});
</script>
{% endblock %}
